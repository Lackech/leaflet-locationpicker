/* 
 * Leaflet Location Picker v0.2.1 - 2015-08-25 
 * 
 * Copyright 2015 Stefano Cudini 
 * stefano.cudini@gmail.com 
 * http://labs.easyblog.it/ 
 * 
 * Licensed under the MIT license. 
 * 
 * Demo: 
 * http://labs.easyblog.it/maps/leaflet-locationpicker/ 
 * 
 * Source: 
 * git@github.com:stefanocudini/leaflet-locationpicker.git 
 * 
 */
!function(a,b){var c=a;c.fn.leafletLocationPicker=function(a,d){function e(c){return c?b.latLng(parseFloat(c.lat).toFixed(a.locationDigits),parseFloat(c.lng).toFixed(a.locationDigits)):c}function f(d){var f=d;switch(c.type(d)){case"string":var g=d.split(a.locationSep);f=g[0]&&g[1]?b.latLng(g):null;break;default:f=d}return e(f)}function g(d){d.divMap=document.createElement("div"),d.$map=c(document.createElement("div")).addClass(a.className+"-map").height(a.height).width(a.width).append(d.divMap).appendTo("body"),d.location&&(a.map.center=d.location),"string"==typeof a.layer&&j[a.layer]?a.map.layers=b.tileLayer(j[a.layer]):a.layer instanceof b.TileLayer||a.layer instanceof b.LayerGroup?a.map.layers=a.layer:a.map.layers=b.tileLayer(j.OSM),d.map=b.map(d.divMap,a.map).addControl(b.control.zoom({position:"bottomright"})).on("click",function(a){d.setLocation(a.latlng)}),a.activeOnMove&&d.map.on("move",function(a){d.setLocation(a.target.getCenter())});var e=b.control({position:"topright"});return e.onAdd=function(c){var e=b.DomUtil.create("div","leaflet-control "+a.className+"-close");return e.innerHTML="&times;",b.DomEvent.on(e,"click",b.DomEvent.stop,d).on(e,"click",d.closeMap,d),e},e.addTo(d.map),a.locationMarker&&(d.marker=h(d.location).addTo(d.map)),d.$map}function h(c){var d="padding:0; margin:-1px; position: absolute; outline: 1px solid #fff; box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.6);";return b.marker(f(c)||b.latLng(0,0),{icon:b.divIcon({className:a.className+"-marker",iconAnchor:b.point(0,0),html:'<div style="position: relative; padding: 0px; margin: 0px; width: 1em; height: 1em;"><div style="width: 50%; height: 0px; left: -80%; border-top:  2px solid black;'+d+'"></div><div style="width: 50%; height: 0px; left:  30%; border-top:  2px solid black;'+d+'"></div><div style="width: 0px; height: 50%; top:   30%; border-left: 2px solid black;'+d+'"></div><div style="width: 0px; height: 50%; top:  -80%; border-left: 2px solid black;'+d+'"></div></div>'})})}var i="leaflet-locpicker",j={OSM:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",SAT:"http://otile1.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.png"},k={zoom:14,center:b.latLng([50.08,14.43]),zoomControl:!1,attributionControl:!1};c.isPlainObject(a)&&c.isPlainObject(a.map)&&(k=c.extend(k,a.map));var l={className:i,location:k.center,locationFormat:"{lat}{sep}{lng}",locationMarker:!0,locationDigits:6,locationSep:",",activeOnMove:!1,position:"topright",layer:"OSM",height:120,width:180,map:k,onChangeLocation:c.noop};return a=c.isPlainObject(a)?c.extend(l,a):c.isFunction(a)?c.extend(l,{onChangeLocation:a}):l,c.isFunction(d)&&(a=c.extend(l,{onChangeLocation:d})),c(this).each(function(d,e){var h=this;h.$input=c(this),h.locationOri=h.$input.val(),h.onChangeLocation=function(){var b={latlng:h.location,location:h.getLocation()};h.$input.trigger(c.extend(b,{type:"changeLocation"})),a.onChangeLocation.call(h,b)},h.setLocation=function(a,b){h.location=f(a),h.marker&&h.marker.setLatLng(a),h.$input.data("location",h.location),h.$input.val(h.getLocation()),h.onChangeLocation()},h.getLocation=function(){return h.location?b.Util.template(a.locationFormat,{lat:h.location.lat,lng:h.location.lng,sep:a.locationSep}):h.location},h.openMap=function(){switch(a.position){case"bottomleft":h.$map.css({top:h.$input.offset().top+h.$input.height()+6,left:h.$input.offset().left});break;case"topright":h.$map.css({top:h.$input.offset().top,left:h.$input.offset().left+h.$input.width()+5})}h.$map.show(),h.map.invalidateSize(),h.$input.trigger("show")},h.closeMap=function(){h.$map.hide(),h.$input.trigger("hide")},h.setLocation(h.locationOri),h.$map=g(h),h.$input.addClass(a.className).on("focus."+a.className,function(a){console.log("focus:",a),a.preventDefault(),h.openMap()}).on("blur."+a.className,function(a){a.preventDefault();for(var b=a.relatedTarget,c=!0;b;){if(b._leaflet){c=!1;break}b=b.parentElement}console.log("blur:",a,c),c&&h.closeMap()}),h.$map.on("click",function(a){console.log("map click:",a)}),h.$map.on("focus",function(a){console.log("map focus:",a)}),h.$map.on("blur",function(a){console.log("map blur:",a)})}),this}}(jQuery,L);